[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Designation",
  "enabled": 1,
  "modified": "2025-12-08 17:41:02.345623",
  "module": "Gvm Payroll",
  "name": "Add filter on designation level selection",
  "script": "frappe.ui.form.on('Designation Matrix Level', {\n    refresh(frm) {\n        console.log(\"test\")\n        // Replace 'matrix_levels' with your child table fieldname\n        frm.fields_dict['custom_matrix_levels'].grid.get_field('pay_matrix_level').get_query = function(doc, cdt, cdn) {\n            return {\n                filters: [\n                    [\"Pay Matrix Level\", \"pay_matrix\", \"=\", doc.pay_matrix]\n                ]\n            };\n        };\n    }\n});\n\n\nfrappe.ui.form.on('Designation Matrix Level', {\n\trefresh(frm) {\n\t\t// your code here\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-12-09 14:12:45.344964",
  "module": "Gvm Payroll",
  "name": "Set the basic salary",
  "script": "frappe.ui.form.on('Employee', {\n    before_save: function(frm) {\n        if (frm.doc.designation && frm.doc.custom_pay_matrix && \n            (frm.doc.custom_years_experienced || frm.doc.custom_years_experienced === 0)) {\n            update_basic_salary(frm);\n        }\n        if (frm.doc.designation && frm.doc.custom_pay_matrix) {\n            update_level(frm);\n        }\n    },\n    \n    custom_years_experienced: function(frm) {\n        update_basic_salary(frm);\n    },\n    \n    custom_pay_matrix: function(frm) {\n        update_basic_salary(frm);\n        update_level(frm);\n    },\n    \n    designation: function(frm) {\n        update_basic_salary(frm);\n        update_level(frm);\n    },\n});\n\nasync function update_level(frm) {\n    if (!frm.doc.designation) {\n        console.log('Designation field is empty');\n        return;\n    }\n    \n    if (!frm.doc.custom_pay_matrix) {\n        console.log('Pay Matrix field is empty');\n        return;\n    }\n    \n    try {\n        const designation = await frappe.db.get_doc('Designation', frm.doc.designation);\n        \n        if (!designation.custom_matrix_levels || designation.custom_matrix_levels.length === 0) {\n            return;\n        }\n        const matchingLevel = designation.custom_matrix_levels.find(\n            level => level.pay_matrix === frm.doc.custom_pay_matrix\n        );\n        \n        if (!matchingLevel) {\n            return;\n        }\n        \n\n        frm.set_value('custom_level', matchingLevel.level);\n        frm.refresh_field(\"custom_level\")\n        \n\n    } catch (error) {\n        console.error('Error during level fetching:', error);\n    }\n}\n\nasync function update_basic_salary(frm) {\n    console.log('=== Starting Basic Salary Calculation ===');\n    \n    // Check if all required fields are present\n    if (!frm.doc.designation) {\n        console.log('Designation field is empty');\n        return;\n    }\n    \n    if (!frm.doc.custom_pay_matrix) {\n        console.log('Pay Matrix field is empty');\n        return;\n    }\n    \n    if (!frm.doc.custom_years_experienced && frm.doc.custom_years_experienced !== 0) {\n        console.log('Years Experienced field is empty');\n        return;\n    }\n    \n    console.log('Required fields present:', {\n        designation: frm.doc.designation,\n        payMatrix: frm.doc.custom_pay_matrix,\n        yearsExperience: frm.doc.custom_years_experienced\n    });\n    \n    try {\n        // Step 1: Fetch designation details\n        console.log('Fetching designation details...');\n        const designation = await frappe.db.get_doc('Designation', frm.doc.designation);\n        console.log(\"designation\", designation)\n        \n        if (!designation.custom_matrix_levels || designation.custom_matrix_levels.length === 0) {\n            console.log('No matrix levels found in designation');\n            return;\n        }\n        \n        console.log('Designation fetched with', designation.custom_matrix_levels.length, 'matrix levels');\n        \n        // Step 2: Find matching pay matrix\n        console.log('Finding matching pay matrix level...');\n        const matchingLevel = designation.custom_matrix_levels.find(\n            level => level.pay_matrix === frm.doc.custom_pay_matrix\n        );\n        \n        if (!matchingLevel) {\n            console.log('No matching pay matrix found in designation levels');\n            return;\n        }\n        \n        console.log('Matching level found:', matchingLevel.level);\n        \n        // Step 3: Fetch Pay Matrix Level\n        console.log('Fetching Pay Matrix Level details...');\n        const payMatrixLevel = await frappe.db.get_doc('Pay Matrix Level', matchingLevel.level);\n        \n        if (!payMatrixLevel || !payMatrixLevel.years || payMatrixLevel.years.length === 0) {\n            console.log('No years data found in Pay Matrix Level');\n            return;\n        }\n        \n        console.log('Pay Matrix Level fetched with', payMatrixLevel.years.length, 'years data');\n        \n        // Step 4: Find matching year based on experience\n        console.log('Finding matching year for experience:', frm.doc.custom_years_experienced);\n        \n        let targetYear = frm.doc.custom_years_experienced;\n        const availableYears = payMatrixLevel.years.map(y => y.year).sort((a, b) => a - b);\n        \n        // Find exact match or closest lower year\n        let matchingYear = payMatrixLevel.years.find(y => y.year === targetYear);\n        \n        if (!matchingYear) {\n            const lowerYears = payMatrixLevel.years\n                .filter(y => y.year <= targetYear)\n                .sort((a, b) => b.year - a.year);\n            \n            if (lowerYears.length > 0) {\n                matchingYear = lowerYears[0];\n                console.log('Exact year not found. Using closest lower year:', matchingYear.year);\n            }\n        }\n        \n        if (!matchingYear) {\n            console.log('No matching year found for experience');\n            return;\n        }\n        \n        console.log('Matching year found:', matchingYear.year, 'Amount:', matchingYear.amount);\n        \n        // Step 5: Update the basic salary field\n        console.log('Updating basic salary field to:', matchingYear.amount);\n        frm.set_value('custom_basic_salary', matchingYear.amount);\n        \n        console.log('Basic salary calculation completed');\n        \n    } catch (error) {\n        console.error('Error during salary calculation:', error);\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-12-11 00:00:00.000000",
  "module": "Gvm Payroll",
  "name": "Filter Increment Date",
  "script": "frappe.ui.form.on('Employee', {\n    refresh: function(frm) {\n        // Set description for custom_date_of_increment field\n        if (frm.fields_dict.custom_date_of_increment) {\n            update_increment_date_description(frm);\n        }\n    },\n    \n    company: function(frm) {\n        // Update description when company changes\n        if (frm.fields_dict.custom_date_of_increment) {\n            update_increment_date_description(frm);\n        }\n    },\n    \n    custom_date_of_increment: function(frm) {\n        // Validate on change\n        if (frm.doc.custom_date_of_increment) {\n            validate_increment_date(frm);\n        }\n    }\n});\n\nasync function update_increment_date_description(frm) {\n    try {\n        const result = await frappe.call({\n            method: 'gvm_payroll.gvm_payroll.doctype.ind_payroll_setting.ind_payroll_setting.get_increment_dates_list',\n            args: {\n                company: frm.doc.company || ''\n            }\n        });\n        \n        if (result && result.message && result.message.length > 0) {\n            const dates = result.message.map(d => frappe.datetime.str_to_user(d)).join(', ');\n            frm.set_df_property('custom_date_of_increment', 'description', `Allowed dates: ${dates}`);\n        }\n    } catch (e) {\n        console.error('Error fetching increment dates:', e);\n    }\n}\n\nasync function validate_increment_date(frm) {\n    if (!frm.doc.custom_date_of_increment) return;\n    \n    try {\n        const result = await frappe.call({\n            method: 'gvm_payroll.gvm_payroll.doctype.ind_payroll_setting.ind_payroll_setting.get_increment_dates_list',\n            args: {\n                company: frm.doc.company || ''\n            }\n        });\n        \n        if (result && result.message && result.message.length > 0) {\n            const selected_date = frappe.datetime.str_to_user(frm.doc.custom_date_of_increment);\n            const allowed_dates = result.message.map(d => frappe.datetime.str_to_user(d));\n            \n            if (!allowed_dates.includes(selected_date)) {\n                frappe.msgprint({\n                    title: __('Invalid Date'),\n                    message: __('Increment Date must be one of: ' + allowed_dates.join(', ')),\n                    indicator: 'orange'\n                });\n                frm.set_value('custom_date_of_increment', '');\n            }\n        }\n    } catch (e) {\n        console.error('Error validating increment date:', e);\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payroll Entry",
  "enabled": 1,
  "modified": "2025-12-11 00:00:00.000000",
  "module": "Gvm Payroll",
  "name": "Attach Quarter Charges",
  "script": "frappe.ui.form.on('Payroll Entry', {\n    refresh: function(frm) {\n        if (frm.doc.__islocal) return; // only after save\n        if (frm.doc.employees && frm.doc.employees.length) {\n            frm.add_custom_button(__('Attach Quarter Charges'), () => attach_quarter_charges(frm));\n        }\n    }\n});\n\nasync function attach_quarter_charges(frm) {\n    try {\n        const res = await frappe.call({\n            method: 'gvm_payroll.gvm_payroll.api.payroll_entry.create_quarter_additional_salaries',\n            args: { payroll_entry: frm.doc.name },\n            freeze: true,\n            freeze_message: __('Creating Additional Salaries from Quarter charges...'),\n        });\n\n        const created = res.message?.created || [];\n        const skipped = res.message?.skipped || [];\n\n        let msg = '';\n        if (created.length) {\n            msg += __('Created and Submitted Additional Salary: ') + created.join(', ') + '<br>';\n        }\n        if (skipped.length) {\n            const reasons = skipped.map(s => `${s.employee || ''} ${s.component || ''} (${s.reason || ''})`).join(', ');\n            msg += __('Skipped: ') + reasons;\n        }\n        frappe.msgprint({\n            title: __('Quarter Charges'),\n            message: msg || __('No records created'),\n            indicator: 'green'\n        });\n        frm.reload_doc();\n    } catch (e) {\n        console.error(e);\n        frappe.msgprint({\n            title: __('Error'),\n            message: e.message || __('Failed to create Additional Salaries'),\n            indicator: 'red'\n        });\n    }\n}",
  "view": "Form"
 }
]
