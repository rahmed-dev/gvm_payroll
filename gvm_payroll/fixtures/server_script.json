[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": "0 0 * * *",
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "Cron",
  "modified": "2025-12-11 00:00:00.000000",
  "module": "Gvm Payroll",
  "name": "Update Employee Experience Year",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Helper function to convert increment date string to actual date\ndef get_increment_date_from_string(date_str, year):\n    if date_str == \"1st April\":\n        return frappe.utils.getdate(f\"{year}-04-01\")\n    elif date_str == \"1st October\":\n        return frappe.utils.getdate(f\"{year}-10-01\")\n    return None\n\n# Update employee experience year based on increment dates from IND Payroll Setting\ntoday = frappe.utils.nowdate()\ncurrent_date = frappe.utils.getdate(today)\n\n# Get increment date strings from IND Payroll Setting\nincrement_date_strings = []\npayroll_settings = frappe.get_all(\"IND Payroll Setting\", fields=[\"name\", \"company\"])\n\nfor setting in payroll_settings:\n    setting_doc = frappe.get_doc(\"IND Payroll Setting\", setting.name)\n    for inc_date in setting_doc.increment_dates:\n        if inc_date.increment_date and inc_date.increment_date not in increment_date_strings:\n            increment_date_strings.append(inc_date.increment_date)\n\n# If no increment dates configured, use default April 1 and October 1\nif not increment_date_strings:\n    increment_date_strings = [\"1st April\", \"1st October\"]\n\n# Convert to actual dates for current year\nincrement_dates = []\nfor date_str in increment_date_strings:\n    date_obj = get_increment_date_from_string(date_str, current_date.year)\n    if date_obj:\n        increment_dates.append(date_obj)\n\n# Only proceed if today is one of the increment dates\nif current_date in increment_dates:\n    employees = frappe.get_all(\"Employee\", fields=[\"name\", \"date_of_joining\", \"custom_years_experienced\", \"company\"])\n    \n    for emp in employees:\n        if not emp.date_of_joining:\n            continue\n    \n        doj = frappe.utils.getdate(emp.date_of_joining)\n        years_completed = frappe.utils.date_diff(current_date, doj) // 365\n    \n        # If years_completed is already equal to field value, do nothing\n        if emp.custom_years_experienced and years_completed <= emp.custom_years_experienced:\n            continue\n    \n        # Get increment date strings for employee's company\n        emp_increment_date_strings = increment_date_strings\n        if emp.company:\n            setting = frappe.db.get_value(\"IND Payroll Setting\", {\"company\": emp.company}, \"name\")\n            if setting:\n                setting_doc = frappe.get_doc(\"IND Payroll Setting\", setting)\n                emp_increment_date_strings = []\n                for inc_date in setting_doc.increment_dates:\n                    if inc_date.increment_date:\n                        emp_increment_date_strings.append(inc_date.increment_date)\n        \n        # Calculate one year from date of joining\n        one_year_date = frappe.utils.add_years(doj, 1)\n        one_year_year = one_year_date.year\n        \n        # Get Date 1 (1st April) and Date 2 (1st October) for the year when one year completes\n        date1 = None\n        date2 = None\n        for date_str in emp_increment_date_strings:\n            if date_str == \"1st April\":\n                date1 = get_increment_date_from_string(date_str, one_year_year)\n            elif date_str == \"1st October\":\n                date2 = get_increment_date_from_string(date_str, one_year_year)\n        \n        # If one year is completed by Date 1, use Date 1, otherwise use Date 2\n        valid_increment_date = None\n        if date1 and one_year_date <= date1:\n            valid_increment_date = date1\n        elif date2:\n            valid_increment_date = date2\n        \n        # If no date found, use first increment date of next year\n        if not valid_increment_date and emp_increment_date_strings:\n            first_date_str = emp_increment_date_strings[0]\n            valid_increment_date = get_increment_date_from_string(first_date_str, one_year_year + 1)\n    \n        # Now increment ONLY if today == valid increment date\n        if valid_increment_date and current_date == valid_increment_date:\n            new_years = (emp.custom_years_experienced or 0) + 1\n            frappe.db.set_value(\"Employee\", emp.name, \"custom_years_experienced\", new_years)\n",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-11 00:00:00.000000",
  "module": "Gvm Payroll",
  "name": "Set Employee Increment Date",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee",
  "script": "# Helper function to convert increment date string to actual date\ndef get_increment_date_from_string(date_str, year):\n    if date_str == \"1st April\":\n        return frappe.utils.getdate(f\"{year}-04-01\")\n    elif date_str == \"1st October\":\n        return frappe.utils.getdate(f\"{year}-10-01\")\n    return None\n\n# Set custom_date_of_increment based on date_of_joining if not already set\n\nif doc.date_of_joining and not doc.custom_date_of_increment:\n    # Get increment date strings from IND Payroll Setting for employee's company\n    increment_date_strings = []\n    if doc.company:\n        setting = frappe.db.get_value(\"IND Payroll Setting\", {\"company\": doc.company}, \"name\")\n        if setting:\n            setting_doc = frappe.get_doc(\"IND Payroll Setting\", setting)\n            for inc_date in setting_doc.increment_dates:\n                if inc_date.increment_date:\n                    increment_date_strings.append(inc_date.increment_date)\n    \n    # If no company-specific dates, get from any setting\n    if not increment_date_strings:\n        payroll_settings = frappe.get_all(\"IND Payroll Setting\", fields=[\"name\"], limit=1)\n        if payroll_settings:\n            setting_doc = frappe.get_doc(\"IND Payroll Setting\", payroll_settings[0].name)\n            for inc_date in setting_doc.increment_dates:\n                if inc_date.increment_date:\n                    increment_date_strings.append(inc_date.increment_date)\n    \n    # If still no dates, use default April 1 and October 1\n    if not increment_date_strings:\n        increment_date_strings = [\"1st April\", \"1st October\"]\n    \n    # Get current date and year\n    today = frappe.utils.nowdate()\n    current_date = frappe.utils.getdate(today)\n    current_year = current_date.year\n    \n    # Calculate one year from date of joining\n    doj = frappe.utils.getdate(doc.date_of_joining)\n    one_year_date = frappe.utils.add_years(doj, 1)\n    \n    # Find the next increment date from current year onwards\n    # Check increment dates starting from current year up to 2 years ahead\n    valid_increment_date = None\n    \n    for year_offset in range(0, 3):\n        check_year = current_year + year_offset\n        \n        # Get Date 1 (1st April) and Date 2 (1st October) for this year\n        date1 = None\n        date2 = None\n        for date_str in increment_date_strings:\n            if date_str == \"1st April\":\n                date1 = get_increment_date_from_string(date_str, check_year)\n            elif date_str == \"1st October\":\n                date2 = get_increment_date_from_string(date_str, check_year)\n        \n        # Apply logic: If 1 year is completed by Date 1, use Date 1, otherwise Date 2\n        # But only if the date is >= one_year_date\n        if date1 and date1 >= one_year_date:\n            if one_year_date <= date1:\n                # One year is completed by Date 1, so increment date is Date 1\n                valid_increment_date = date1\n                break\n        \n        if date2 and date2 >= one_year_date:\n            # One year is NOT completed by Date 1 (or Date 1 doesn't exist), so increment date is Date 2\n            valid_increment_date = date2\n            break\n    \n    # If still no date found, use first increment date of next year after one year completion\n    if not valid_increment_date and increment_date_strings:\n        one_year_year = one_year_date.year\n        first_date_str = increment_date_strings[0]\n        valid_increment_date = get_increment_date_from_string(first_date_str, one_year_year + 1)\n    \n    if valid_increment_date:\n        doc.custom_date_of_increment = valid_increment_date\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Validate",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-11 00:00:00.000000",
  "module": "Gvm Payroll",
  "name": "Validate Employee Increment Date",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee",
  "script": "# Helper function to convert increment date string to actual date\ndef get_increment_date_from_string(date_str, year):\n    if date_str == \"1st April\":\n        return frappe.utils.getdate(f\"{year}-04-01\")\n    elif date_str == \"1st October\":\n        return frappe.utils.getdate(f\"{year}-10-01\")\n    return None\n\n# Validate that custom_date_of_increment is from allowed increment dates\n\nif doc.custom_date_of_increment:\n    # Get increment date strings from IND Payroll Setting\n    increment_date_strings = []\n    if doc.company:\n        setting = frappe.db.get_value(\"IND Payroll Setting\", {\"company\": doc.company}, \"name\")\n        if setting:\n            setting_doc = frappe.get_doc(\"IND Payroll Setting\", setting)\n            for inc_date in setting_doc.increment_dates:\n                if inc_date.increment_date:\n                    increment_date_strings.append(inc_date.increment_date)\n    \n    # If no company-specific dates, get from any setting\n    if not increment_date_strings:\n        payroll_settings = frappe.get_all(\"IND Payroll Setting\", fields=[\"name\"], limit=1)\n        if payroll_settings:\n            setting_doc = frappe.get_doc(\"IND Payroll Setting\", payroll_settings[0].name)\n            for inc_date in setting_doc.increment_dates:\n                if inc_date.increment_date:\n                    increment_date_strings.append(inc_date.increment_date)\n    \n    # If dates configured, validate that the selected date matches one of the allowed increment dates\n    if increment_date_strings:\n        selected_date = frappe.utils.getdate(doc.custom_date_of_increment)\n        selected_year = selected_date.year\n        \n        # Check if selected date matches any of the allowed increment dates for that year\n        is_valid = False\n        for date_str in increment_date_strings:\n            allowed_date = get_increment_date_from_string(date_str, selected_year)\n            if allowed_date and selected_date == allowed_date:\n                is_valid = True\n                break\n        \n        if not is_valid:\n            allowed_dates_str = \", \".join(increment_date_strings)\n            frappe.throw(f\"Increment Date must be one of: {allowed_dates_str}\")\n",
  "script_type": "DocType Event"
 }
]